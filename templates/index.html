{% extends "layout.html" %}

{% block title %}Index{% endblock %}

{% block extra_topjs %}
	<script type="text/javascript">
		var myData = {{ dayStats|raw }}; // data parsed by PHP (class_stats.php)

		function dateToYMD(date) {
		    var d = date.getDate();
		    var m = date.getMonth() + 1;
		    var y = date.getFullYear();
		    return '' + y + '-' + (m<=9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);
		}

		function outputFooter() {
			var selectedDay = "";

			if(myData.length != 0) {
				selectedDay = myData[0].split(" ", 1); // get selected day
			} else {
				selectedDay = window.location.pathname;
				selectedDay = selectedDay.substring(selectedDay.lastIndexOf('/') + 1); // remove slash at the beginning
	    	}
 
 			var today = new Date(selectedDay);
			var tomorrow = new Date(selectedDay);
			var yesterday = new Date(selectedDay);

			tomorrow.setDate(tomorrow.getDate() + 1);
			yesterday.setDate(yesterday.getDate() - 1);	  

			document.writeln("<a href='" + dateToYMD(yesterday) + "'>Previous</a><span id='footerText'>Viewing " + dateToYMD(today) + "</span><a href='" + dateToYMD(tomorrow) + "'>Next</a>");
		}
	</script>
{% endblock %}

{% block content %}
	<div id="myChart">

	</div>

	<style>
		#footerArea {
			text-align:center;
		}

		#footerText {
			padding-left:25px;
			padding-right:25px;
		}
	</style>

	<div id='footerArea'>
		<script>outputFooter();</script>
	</div>
{% endblock %}

{% block extra_bottomjs %}
	<script src="{{ app.request.basepath }}js/highcharts/highcharts.js"></script>
	<script src="{{ app.request.basepath }}js/highcharts/modules/exporting.js"></script>

	<script type="text/javascript">
		function drawChart(renderDiv)
		{
			var chartConfig = {
				chart: {
					type: 'area',
					renderTo: renderDiv
				},
				title: {
					text: 'Energy production',
					x: -20
				},
				plotOptions: {
					area: {
						shadow: false,
						states: {
							hover: {
								lineWidth: 2
							}
						},
						marker: {
							enabled: false,
							states: {
								hover: {
									enabled: true,
									radius: 4,
									lineWidth: 1
								}
							}
						}
					}
				},
				xAxis: {
					type: 'datetime',
       				tickInterval: 7200000,
				},
				yAxis: {
					title: {
						text: 'kW'
					},
					plotLines: [{
						value: 0,
						width: 1,
						color: '#808080'
					}],
				},
				credits: {
					enabled:false
				},
				tooltip: {
					valueSuffix: 'kW',
					snap:1
				},
				legend: {
					layout: 'vertical',
					align: 'right',
					verticalAlign: 'middle',
					borderWidth: 0
				},
				series: [{
					name: 'kW generated',
					data: []
				}]
			};

// -------------------------------------------------------------------------

	console.log( {{dayStats|raw}});

			for (var i = 0; i < myData.length; i++) {
				// Replace non-digit and non decimal characters with a space
				myData[i] = myData[i].replace(/[^0-9.]/g," ");

				// Split data
				var date_parts = myData[i].split(" ");

				// adds the date and value of kW to array of series data
				var date = Date.UTC(date_parts[0], date_parts[1], date_parts[2], date_parts[3], date_parts[4], date_parts[5]);

				if(i == 0) { // we start with 0 kW 5 minutes earlier
					chartConfig.series[0].data.push([date-300000, 0.0]); // 60000 ms * 5 = 300000 = 5 min
				} else if(i == myData.length-1) { // we end with 0 kW 5 minutes later
					chartConfig.series[0].data.push([date+300000, 0.0]);
				}
       			chartConfig.series[0].data.push([date, parseFloat(date_parts[6])]);
       		}
			new Highcharts.Chart(chartConfig);
		}

		drawChart('myChart');
	</script>
{% endblock %}